# 使用者

在 Linux 中，一個 OS 裡可以存在若干個 users，user 可以被操作者建立與刪除，但其中必定會有一個叫做 `root` 的 user，`root` 又叫做 superuser，擁有系統的所有權限。

由於 `root` 的權限過高，因此不建議平時就以 `root` 的身份登入系統，因為若直接使用 root 登入系統，那麼你執行的應用程式就可以任意存取所有系統中的檔案、執行任何動作，應用程式中永遠都有可能存在 bug 或是惡意的程式，因此這是非常危險的。

較好的做法是平時使用 non-root user 登入，有需要取得 `root` 才有的權限時再行取得權限。

### 取得 `root` 權限

> [!Note]
> 在使用指令取得 `root` 權限之前，你必須先知道 `root` user 的密碼。

使用 `su` 可以取得 `root` user 的權限：

```bash
su
```

但光使用 `su` 並不會讓環境跟著變，也就是說你現在還是在原本 user 的環境，只是有了 `root` 的權限可以可以做一些原本不能做的動作而已，如果要連環境一起變成 `root` 的環境（也就是以 `root` 登入的意思），需要加一個 `-`：

```bash
su -
```

使用 `su` 指令會被要求輸入 `root` user 的密碼，輸入正確後會進入一個新的 shell，如果要離開這個 shell 需輸入指令 `exit`。

如果切換為 `root` 後只要簡單執行一個指令便離開，可以使用 `-c` option，舉例如下：

```bash
su - -c "ls"
```

上面的例子就是以 `root` user 的身份登入，然後在 home directory 執行 `ls` 後離開 `root` 的 shell。

### 取得其他 User 的權限

由於 `root` 又叫 superuser，是所有 user 的管理者，因此 `su` 也可以用來任意 user 的權限，pattern 為：

```bash
su <USERNAME>
```

此時要輸入的密碼就是 `<USERNAME>` 的密碼，不過如果是在 `root` 環境之下使用 `su <USERNAME>` 就不用輸入密碼。

### `sudo`

`sudo` 與 `su` 的差別在於輸入的密碼，使用 `su` 要輸入的是 `root` 的密碼；使用 `sudo` 輸入的是「目前 user 的密碼」。

`sudo` 在使用上與 `su -c` 類似，在後面直接加上想下的指令，比如：

```bash
sudo ls
```

加上 `-u` option 則可以取得指定 user 的權限：

```bash
sudo -u <USERNAME> ls
```

加上 `-g` option 可以取的指定 group 的權限：

```bash
sudo -g admin ls
```

由於 `sudo` 是後面直接接著指令，但有些時候我們想要的是「以 `root` 或其他指定 user 的身份登入」（也就是既取得權限也進入該 user 的環境），此時就將 `sudo` 與 `su -` 合在一起即可：

```bash
sudo su -
```

---

「使用 `sudo` 只需輸入目前 user 的密碼」這聽起來很不合理對吧，如果所有 users 都可以使用 `sudo` 切成 `root`，又只須輸入自己的密碼，那豈不是所有 users 想取得所有權限就取得所有權限了嗎？所以其實在 Linux 系統中使用了 `/etc` 底下的 `sudoers` 檔案來限制哪些 user 可以使用 `sudo`，檔案中的 pattern 如下：

```plaintext
<USER1> <SOURCE_HOST>=(<USER2>) <COMMAND>
```

上面一行設定使得 `<USER1>` 可以從 `<SOURCE_HOST>` 登入 `<USER2>`，並且只能執行 `<COMMAND>` 這個指令。

如果要設定「`<USER1>` 可以從任意 host 登入任意 user，並使用任意 command」，則需設定為 `<USER1> ALL=(ALL) ALL`。

也可以設定群組的權限，須在最前面加一個 `@`：

```plaintext
@<GROUP> <SOURCE_HOST>=(<USER2>) <COMMAND>
```

> [!Note]
> `/etc/sudoers` 這個檔案只有具有 `root` 權限者可以修改，且若要修改，須使用 `visudo` 這個編輯器來修改，系統會在編輯完成後自動檢查設定檔的語法是否正確，避免錯誤的語法導致 `sudo` 無法使用。

### 列出所有 Users

使用下方指令可以列出所有使用者：

```bash
awk -F ':' '{print $1}' /etc/passwd
```

> [!Info]
> 在 MacOS 中須使用下面這個指令：
>
>```bash
>dscl . list /Users | grep -v “^_”
>```

**參考資料**: <https://blog.gtwang.org/linux/sudo-su-command-tutorial-examples/>

# 查看檔案／目錄權限

使用 `ls -l` 可以查看當前 directory 中的所有 files 以及 subdirectory 的詳細資訊，其中就包含權限：

Example Output:

```plaintext
drwxrwxr-x  26 root  admin   832 Apr  3 22:38 Applications
drwxr-xr-x  67 root  wheel  2144 Mar 20 17:24 Library
drwxr-xr-x@ 10 root  wheel   320 Feb  9 17:39 System
drwxr-xr-x   5 root  admin   160 Mar 14 16:23 Users
dr-xr-xr-x   4 root  wheel  4804 Mar 15 11:27 dev
lrwxr-xr-x@  1 root  wheel    11 Feb  9 17:39 etc -> private/etc
.
.
.
```

其中每一行的結構如下：

![[Screenshot 2023-04-05 at 12.39.38 PM.png]]

### 常見的 Entry Types

- `-` $\to$ 一般檔案
- `d` $\to$ directory
- `l` $\to$ symbolic (soft) link（捷徑）
- `b` $\to$ 外接儲存裝置（如 USB）
- ...

# 權限的表示方式

針對任何一個 file 或 subdirectory，Linux 皆用九碼的 permission code 來表示所有人對它的存取權限，示意圖如下：

![[Screenshot 2023-04-05 at 2.45.04 PM.png]]

如上圖所示，九碼 permission code 又可以被切分為三個區段，三個區段分別代表三種不同身份，每個區段的三個 codes 分別代表該身份是否有讀、寫、執行某檔案的權限，若有，則會顯示英文字母 `r`/`w`/`x`，若沒有則會顯示 `-`。

舉例來說，如果某檔案的 permission code 為 `rwxr-xr-x`，就代表目前使用者有讀、寫、執行的權限；使用者所屬群組以及其他人則只有讀與執行的權限。

### 數字表示法

除了九碼 permission code，我們也常常使用 3 個數字來表示存取權限，3 個數字分別描述三本九碼 permission code 的三個區段（也就是三種身份的使用者）所擁有的檔案存取權限。換句話說，我們可以將每三個英文字母改用一個數字來表示，比如 `777`、`644` 等，以下介紹要如何轉換：

**Step1: 將 Permission Code 轉為二進制表示法**

我們先把目光聚焦在前三個英文字母（第一區段），已知三個區段不是出現固定的英文字母，就是出現 `-`，因此其實我們可以暫時改用 0/1 來取代它們，如果該位置出現字母就寫 1，出現 `-` 就寫 0，比如 `r-x`  就可以寫成 `101`，完整的範例如 `rwxr-xr-x` 就可以寫成 `111101101`。

**Step2: 將二進制轉為時進制**

由於每個區段長度為三，三位二進制可以表示十進制的 0~7，經過轉換後可以得到下面這張表：

|Permi. Code|`---`|`--x`|`-w-`|`-wx`|`r--`|`r-x`|`rw-`|`rwx`|
|-|-|-|-|-|-|-|-|-|
|數字|0|1|2|3|4|5|6|7|

# 更改權限

### `chmod` 設定權限

- **用數值設定：**

    `chmod <三位數值> <FILE/DIR>`

    e.g. `chmod 644 test.txt`

- **用 Permission Code：**

    `chmod <ROLE><OPERATOR><PERMI_CODE> <FILE/DIR>`

    - Role

        |`u`|`g`|`o`|`a`|
        |---|---|---|---|
        |使用者|群組|其他人|所有人（也可以什麼都不寫）|

    - Operator

        |`+`|`-`|`=`|
        |---|---|---|
        |增加權限|減少權限|重新定義權限|

    e.g. `chmod u-rx test.txt`、`chmod +x test.txt`

### `chown`、`chgrp` 變更擁有者及擁有群組

- **Pattern 1:** `chown <USER>[:<GROUP>] <FILE> [<FILE2> ...]`

- **Pattern 2:** `chown :<GROUP> <FILE>`

    這個 pattern 適用於只想變更所有群組時，其效果等同於 `chgrp <GROUP> <FILE>`。

- 搭配 `-R` option，可以變更 directory 及其底下的所有檔案及 sub-directories 的擁有者：

    ```bash
    chown -R <USER>[:<GROUP>] <DIR> [<DIR2 ...>]
    ```
